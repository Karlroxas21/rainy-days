networks:
  rainydays:
    driver: bridge

services:
  postgres:
    image: postgres:17-alpine
    container_name: rainydays
    profiles:
      - dev
    ports:
      - 5432:5432
    restart: on-failure
    environment:
      POSTGRES_PASSWORD: dev
      POSTGRES_USER: dev
    volumes:
      - ./.data/postgres:/var/lib/postgresql/data
      - ./src/main/resources/db.config/initdb.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
     - rainydays

  ory-kratos-migrate:
    image: oryd/kratos:v1.1.0
    platform: linux/amd64
    container_name: rainydays_kratos_migrate
    profiles:
      - dev
    depends_on:
      - postgres
    command:
      - migrate
      - sql
      - postgres://dev:dev@postgres:5432/rainydays_ory_kratos?sslmode=disable
      - --yes
    networks:
      - rainydays

  ory-kratos:
    platform: linux/amd64
    image: oryd/kratos:v1.1.0
    container_name: rainydays_kratos
    profiles:
      - dev
    depends_on:
      - ory-kratos-migrate
    environment:
      SELFSERVICE_DEFAULT_BROWSER_RETURN_URL: http://localhost:3000
      SELFSERVICE_FLOWS_REGISTRATION_UI_URL: http://localhost:3000/auth/create-account
      COURIER_SMTP_CONNECTION_URI: smtps://foo:bar@my-mailserver:1234/?skip_ssl_verify=false #TODO: config mail server
      DSN: postgres://dev:dev@postgres:5432/rainydays_ory_kratos?sslmode=disable
      IDENTITY_SCHEMAS: '[{ "id": "user", "url": "file:///data/v1-ory-kratos-identity-schema.json" }]'
      IDENTITY_DEFAULT_SCHEMA_ID: user
    volumes:
      - ./misc/v1-ory-kratos-identity-schema.json:/data/v1-ory-kratos-identity-schema.json
    ports:
#      public url
      - 4433:4433
#      private url
      - 4434:4434
    restart: on-failure
    networks:
      - rainydays
